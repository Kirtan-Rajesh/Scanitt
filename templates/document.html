{% extends 'layout.html' %}

{% block title %}{{ document.original_filename }} - Scanitt{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Document Viewer -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">Document Viewer</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" id="viewOriginal">Original</button>
                            <button class="btn btn-sm btn-outline-primary active" id="viewProcessed">Processed</button>
                            <button class="btn btn-sm btn-outline-primary" id="viewText">Text</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Document Controls -->
                    <div class="document-controls p-3 border-bottom">
                        <div class="row align-items-center">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="btn-group me-2">
                                    <button class="btn btn-outline-secondary btn-sm" id="zoomOut">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" id="zoomReset">100%</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="zoomIn">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary btn-sm" id="rotateLeft">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" id="rotateRight">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" id="downloadBtn">
                                        <i class="fas fa-download me-1"></i> Download
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" id="printBtn">
                                        <i class="fas fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Document Display -->
                    <div class="document-display">
                        <div id="imageView" class="zoom-container">
                            <div class="text-center">
                                <img id="documentImage" src="{{ url_for('static', filename=document.processed_path.replace('static/', '')) }}" 
                                     class="document-image img-fluid" alt="{{ document.original_filename }}">
                            </div>
                        </div>
                        <div id="textView" class="document-text" style="display: none;">
                            <pre>{{ document.text }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Document Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Document Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Filename</label>
                        <p class="mb-0 fw-medium">{{ document.original_filename }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">Upload Date</label>
                        <p class="mb-0">{{ document.date_uploaded.strftime('%B %d, %Y at %H:%M') }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label text-muted small">Category</label>
                        <form method="POST" action="{{ url_for('update_category', document_id=document.id) }}" 
                              class="d-flex align-items-center">
                            <select name="category" class="form-select form-select-sm" style="max-width: 200px;">
                                <option value="">Select category</option>
                                <option value="Receipt" {% if document.category == 'Receipt' %}selected{% endif %}>Receipt</option>
                                <option value="Invoice" {% if document.category == 'Invoice' %}selected{% endif %}>Invoice</option>
                                <option value="ID" {% if document.category == 'ID' %}selected{% endif %}>ID</option>
                                <option value="Medical" {% if document.category == 'Medical' %}selected{% endif %}>Medical</option>
                                <option value="Legal" {% if document.category == 'Legal' %}selected{% endif %}>Legal</option>
                                <option value="Note" {% if document.category == 'Note' %}selected{% endif %}>Note</option>
                                <option value="Document" {% if document.category == 'Document' %}selected{% endif %}>Document</option>
                                <option value="Other" {% if document.category and document.category not in ['Receipt', 'Invoice', 'ID', 'Medical', 'Legal', 'Note', 'Document'] %}selected{% endif %}>Other</option>
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary ms-2">
                                <i class="fas fa-save"></i>
                            </button>
                        </form>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label text-muted small">Tags</label>
                        <div>
                            {% if document.tags %}
                            {% for tag in document.tags %}
                            <span class="badge bg-light text-dark tag-badge">{{ tag }}</span>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted mb-0 small">No tags assigned</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            {% if document.summary %}
            <!-- Document Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ document.summary }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
                        </a>
                        <button type="button" class="btn btn-danger" 
                                onclick="confirmDelete('{{ document.id }}', '{{ document.original_filename }}')">
                            <i class="fas fa-trash-alt me-2"></i> Delete Document
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <span id="documentName" class="fw-bold"></span>? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="deleteButton" class="btn btn-danger">Delete</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables for tracking zoom and rotation
    let currentZoom = 1;
    let currentRotation = 0;
    let currentView = 'processed';
    
    // Original and processed image paths
    const originalPath = "{{ url_for('static', filename=document.original_path.replace('static/', '')) }}";
    const processedPath = "{{ url_for('static', filename=document.processed_path.replace('static/', '')) }}";
    
    // Elements
    const documentImage = document.getElementById('documentImage');
    const imageView = document.getElementById('imageView');
    const textView = document.getElementById('textView');
    
    // View selection buttons
    const viewOriginal = document.getElementById('viewOriginal');
    const viewProcessed = document.getElementById('viewProcessed');
    const viewText = document.getElementById('viewText');
    
    // Zoom controls
    const zoomIn = document.getElementById('zoomIn');
    const zoomOut = document.getElementById('zoomOut');
    const zoomReset = document.getElementById('zoomReset');
    
    // Rotation controls
    const rotateLeft = document.getElementById('rotateLeft');
    const rotateRight = document.getElementById('rotateRight');
    
    // Utility functions
    function updateDocumentTransform() {
        documentImage.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
    }
    
    function resetTransform() {
        currentZoom = 1;
        currentRotation = 0;
        updateDocumentTransform();
        zoomReset.textContent = '100%';
    }
    
    // Zoom controls
    zoomIn.addEventListener('click', () => {
        currentZoom += 0.1;
        if (currentZoom > 3) currentZoom = 3;
        zoomReset.textContent = `${Math.round(currentZoom * 100)}%`;
        updateDocumentTransform();
    });
    
    zoomOut.addEventListener('click', () => {
        currentZoom -= 0.1;
        if (currentZoom < 0.5) currentZoom = 0.5;
        zoomReset.textContent = `${Math.round(currentZoom * 100)}%`;
        updateDocumentTransform();
    });
    
    zoomReset.addEventListener('click', () => {
        resetTransform();
    });
    
    // Rotation controls
    rotateLeft.addEventListener('click', () => {
        currentRotation = (currentRotation - 90) % 360;
        updateDocumentTransform();
    });
    
    rotateRight.addEventListener('click', () => {
        currentRotation = (currentRotation + 90) % 360;
        updateDocumentTransform();
    });
    
    // View switching
    viewOriginal.addEventListener('click', () => {
        imageView.style.display = 'block';
        textView.style.display = 'none';
        documentImage.src = originalPath;
        resetTransform();
        
        viewOriginal.classList.add('active');
        viewProcessed.classList.remove('active');
        viewText.classList.remove('active');
        currentView = 'original';
    });
    
    viewProcessed.addEventListener('click', () => {
        imageView.style.display = 'block';
        textView.style.display = 'none';
        documentImage.src = processedPath;
        resetTransform();
        
        viewOriginal.classList.remove('active');
        viewProcessed.classList.add('active');
        viewText.classList.remove('active');
        currentView = 'processed';
    });
    
    viewText.addEventListener('click', () => {
        imageView.style.display = 'none';
        textView.style.display = 'block';
        
        viewOriginal.classList.remove('active');
        viewProcessed.classList.remove('active');
        viewText.classList.add('active');
        currentView = 'text';
    });
    
    // Download button
    document.getElementById('downloadBtn').addEventListener('click', () => {
        const downloadLink = document.createElement('a');
        downloadLink.href = currentView === 'original' ? originalPath : processedPath;
        downloadLink.download = '{{ document.original_filename }}';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    });
    
    // Print button
    document.getElementById('printBtn').addEventListener('click', () => {
        if (currentView === 'text') {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print Document Text</title>');
            printWindow.document.write('<style>body { font-family: monospace; white-space: pre-wrap; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(document.getElementById('textView').innerText);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        } else {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print Document</title>');
            printWindow.document.write('<style>body { display: flex; justify-content: center; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<img src="${currentView === 'original' ? originalPath : processedPath}" style="max-width: 100%;">`);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
    });
    
    // Delete confirmation
    function confirmDelete(documentId, documentName) {
        document.getElementById('documentName').textContent = documentName;
        document.getElementById('deleteButton').href = "{{ url_for('delete_document', document_id='') }}" + documentId;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
</script>
{% endblock %}